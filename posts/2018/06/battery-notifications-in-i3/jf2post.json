{"author":{"name":"Yash Agarwal","type":"card","url":"https://yashagarwal.in/"},"content":{"html":"\u003cp\u003eI am using \u003cem\u003ei3\u003c/em\u003e window manager for the last seven months, and it has been a pleasant and productive experience so far. There were a few hiccups here and there, but that is expected with such minimalistic setups. One thing that I never noticed was the lack of notifications on critical battery levels. For the last few months, my laptop battery was discharging to 0% all the time. Probably this proved to be too fatal for my battery. According to this \u003ca href=\"https://lifehacker.com/5875162/how-often-should-i-charge-my-gadgets-battery-to-prolong-its-lifespan\"\u003earticle\u003c/a\u003e, lithium-ion batteries are not expected to go from 100% to 0% frequently. I recently bought a new battery, and I did not want to reduce the lifespan of this battery too. So I decided to set up battery notifications for my i3 setup.\u003c/p\u003e\n\u003cp\u003eI \u003ca href=\"https://agorf.gr/2016/06/29/low-battery-notification-in-i3wm/\"\u003efound\u003c/a\u003e a bash script which shows a notification using \u003cem\u003enotify-send\u003c/em\u003e when battery charge level reaches or drops below a configured threshold. However, I had to do some additional steps to make this script work on my system.\u003c/p\u003e\n\u003cp\u003eThe first issue was the \u003cem\u003elockfile\u003c/em\u003e program, which was not installed in my system. I installed it using the following command.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo apt install procmail\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe second issue was more difficult to solve. I planned to set up the script to run every minute using \u003cem\u003ecron\u003c/em\u003e. However, it turns out that cron operates in a very \u003ca href=\"http://askubuntu.com/a/23438/173003\"\u003eminimalistic\u003c/a\u003e environment and notify-send requires the presence of some special variables in the environment. These variables are \u003cstrong\u003eDBUS_SESSION_BUS_ADDRESS\u003c/strong\u003e, \u003cstrong\u003eXAUTHORITY\u003c/strong\u003e and \u003cstrong\u003eDISPLAY\u003c/strong\u003e. To provide the values of these variables to the cron environment, I modified the script and sourced a new file \u003ccode\u003e.bat_envs\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env bash\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n. /home/yash/.bat_envs\n\n\u003cspan class=\"nv\"\u003eTHRESHOLD\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e15\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003elock_path\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;/tmp/battery.lock\u0026#39;\u003c/span\u003e\n\nlockfile -r \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"nv\"\u003e$lock_path\u003c/span\u003e 2\u0026gt;/dev/null \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003eacpi_path\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003efind /sys/class/power_supply/ -name \u003cspan class=\"s1\"\u003e\u0026#39;BAT*\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e head -1\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003echarge_now\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$acpi_path\u003c/span\u003e\u003cspan class=\"s2\"\u003e/charge_now\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003echarge_full\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$acpi_path\u003c/span\u003e\u003cspan class=\"s2\"\u003e/charge_full\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003echarge_status\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$acpi_path\u003c/span\u003e\u003cspan class=\"s2\"\u003e/status\u0026#34;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003echarge_percent\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eprintf\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;%.0f\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$charge_now\u003c/span\u003e\u003cspan class=\"s2\"\u003e / \u003c/span\u003e\u003cspan class=\"nv\"\u003e$charge_full\u003c/span\u003e\u003cspan class=\"s2\"\u003e * 100\u0026#34;\u003c/span\u003e\n \u003cspan class=\"p\"\u003e|\u003c/span\u003e bc -l\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n\u003cspan class=\"nv\"\u003emessage\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Battery running critically low at \u003c/span\u003e\u003cspan class=\"nv\"\u003e$charge_percent\u003c/span\u003e\u003cspan class=\"s2\"\u003e%!\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$charge_status\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;Discharging\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e]]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e[[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$charge_percent\u003c/span\u003e -le \u003cspan class=\"nv\"\u003e$THRE\u003c/span\u003e\nSHOLD \u003cspan class=\"o\"\u003e]]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n  /usr/bin/notify-send -u critical \u003cspan class=\"s2\"\u003e\u0026#34;Low battery\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$message\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\n  \u003cspan class=\"nv\"\u003ecurrent_date_time\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;`date +%Y%m%d%H%M%S`\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;[BATTERY LOG] = \u003c/span\u003e\u003cspan class=\"nv\"\u003e$charge_percent\u003c/span\u003e\u003cspan class=\"s2\"\u003e% on \u003c/span\u003e\u003cspan class=\"nv\"\u003e$current_date_time\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\nrm -f \u003cspan class=\"nv\"\u003e$lock_path\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eRead this blog \u003ca href=\"https://agorf.gr/2016/06/29/low-battery-notification-in-i3wm/\"\u003epost\u003c/a\u003e to understand how this script works.\u003c/p\u003e\n\u003cp\u003eAs the notify-send requires some special X session environmental variables, we will need a method to provide these variables to notify-send in cron environment. The safest way to get X session related environmental variables is to get them from the environment of a process of the user who is logged on to X. The following script will run every time a user logs in and stores these variables in a file \u003ccode\u003e.bat_envs\u003c/code\u003e.\u003c/p\u003e\n\u003c!-- raw HTML omitted --\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env bash\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e\u003cspan class=\"s2\"\u003e/.bat_envs\u0026#34;\u003c/span\u003e\n\nrm -f \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\ntouch \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003ecopy_envs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;XAUTHORITY DISPLAY DBUS_SESSION_BUS_ADDRESS\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e env_name in \u003cspan class=\"nv\"\u003e$copy_envs\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    env \u003cspan class=\"p\"\u003e|\u003c/span\u003e grep \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_name\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;export \u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_name\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\nchmod \u003cspan class=\"m\"\u003e600\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eenv_path\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo run this script at startup, I added this file to the i3 config file with the following command.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nb\"\u003eexec\u003c/span\u003e --no-startup-id \u003cspan class=\"s2\"\u003e\u0026#34;path to your script\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen at the end of cron file, I added a new entry for the battery monitoring script.\u003c/p\u003e\n\u003cp\u003eTo open cron file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ecrontab -e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow add the following line to the end of the file and save the file.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e* * * * * bash \u003cspan class=\"s2\"\u003e\u0026#34;path to your script\u0026#34;\u003c/span\u003e \u0026gt;\u0026gt; \u003cspan class=\"s2\"\u003e\u0026#34;path to your log file\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eReplace the \u003cem\u003epath to your script\u003c/em\u003e (with double quotes) with your script path and the \u003cem\u003epath to your log file\u003c/em\u003e with a path where you want to save your log file.\u003c/p\u003e\n\u003cp\u003eNow every minute, this script will be executed, and if your battery percent drops below the threshold value, you will be notified with a notification bubble.\u003c/p\u003e\n\u003cp\u003eI tested this procedure on \u003cem\u003eUbuntu 18.04 with i3\u003c/em\u003e. It should work on Arch Linux and other non-Debian distributions also, but the steps might be slightly different due to various reasons. Please comment if you face any issues with the setup.\u003c/p\u003e\n\u003cp\u003eThank you for reading the article. Cheers ðŸ˜„\u003c/p\u003e\n","text":"I am using i3 window manager for the last seven months, and it has been a pleasant and productive experience so far. There were a few hiccups here and there, but that is expected with such minimalistic setups. One thing that I never noticed was the lack of notifications on critical battery levels. For the last few months, my laptop battery was discharging to 0% all the time. Probably this proved to be too fatal for my battery. According to this article, lithium-ion batteries are not expected to go from 100% to 0% frequently. I recently bought a new battery, and I did not want to reduce the lifespan of this battery too. So I decided to set up battery notifications for my i3 setup.\nI found a bash script which shows a notification using notify-send when battery charge level reaches or drops below a configured threshold. However, I had to do some additional steps to make this script work on my system.\nThe first issue was the lockfile program, which was not installed in my system. I installed it using the following command.\nsudo apt install procmail The second issue was more difficult to solve. I planned to set up the script to run every minute using cron. However, it turns out that cron operates in a very minimalistic environment and notify-send requires the presence of some special variables in the environment. These variables are DBUS_SESSION_BUS_ADDRESS, XAUTHORITY and DISPLAY. To provide the values of these variables to the cron environment, I modified the script and sourced a new file .bat_envs.\n#!/usr/bin/env bash  . /home/yash/.bat_envs THRESHOLD=15 lock_path=\u0026#39;/tmp/battery.lock\u0026#39; lockfile -r 0 $lock_path 2\u0026gt;/dev/null || exit acpi_path=$(find /sys/class/power_supply/ -name \u0026#39;BAT*\u0026#39; | head -1) charge_now=$(cat \u0026#34;$acpi_path/charge_now\u0026#34;) charge_full=$(cat \u0026#34;$acpi_path/charge_full\u0026#34;) charge_status=$(cat \u0026#34;$acpi_path/status\u0026#34;) charge_percent=$(printf \u0026#39;%.0f\u0026#39; $(echo \u0026#34;$charge_now/ $charge_full* 100\u0026#34; | bc -l)) message=\u0026#34;Battery running critically low at $charge_percent%!\u0026#34; if [[ $charge_status == \u0026#39;Discharging\u0026#39; ]] \u0026amp;\u0026amp; [[ $charge_percent -le $THRE SHOLD ]]; then /usr/bin/notify-send -u critical \u0026#34;Low battery\u0026#34; \u0026#34;$message\u0026#34; current_date_time=\u0026#34;`date +%Y%m%d%H%M%S`\u0026#34;; echo \u0026#34;[BATTERY LOG] = $charge_percent% on $current_date_time\u0026#34; fi rm -f $lock_path Read this blog post to understand how this script works.\nAs the notify-send requires some special X session environmental variables, we will need a method to provide these variables to notify-send in cron environment. The safest way to get X session related environmental variables is to get them from the environment of a process of the user who is logged on to X. The following script will run every time a user logs in and stores these variables in a file .bat_envs.\n#!/usr/bin/env bash  env_path=\u0026#34;$HOME/.bat_envs\u0026#34; rm -f \u0026#34;${env_path}\u0026#34; touch \u0026#34;${env_path}\u0026#34; copy_envs=\u0026#34;XAUTHORITY DISPLAY DBUS_SESSION_BUS_ADDRESS\u0026#34; for env_name in $copy_envs do env | grep \u0026#34;${env_name}\u0026#34; \u0026gt;\u0026gt; \u0026#34;${env_path}\u0026#34;; echo \u0026#34;export ${env_name}\u0026#34; \u0026gt;\u0026gt; \u0026#34;${env_path}\u0026#34;; done chmod 600 \u0026#34;${env_path}\u0026#34; To run this script at startup, I added this file to the i3 config file with the following command.\nexec --no-startup-id \u0026#34;path to your script\u0026#34; Then at the end of cron file, I added a new entry for the battery monitoring script.\nTo open cron file:\ncrontab -e Now add the following line to the end of the file and save the file.\n* * * * * bash \u0026#34;path to your script\u0026#34; \u0026gt;\u0026gt; \u0026#34;path to your log file\u0026#34; Replace the path to your script (with double quotes) with your script path and the path to your log file with a path where you want to save your log file.\nNow every minute, this script will be executed, and if your battery percent drops below the threshold value, you will be notified with a notification bubble.\nI tested this procedure on Ubuntu 18.04 with i3. It should work on Arch Linux and other non-Debian distributions also, but the steps might be slightly different due to various reasons. Please comment if you face any issues with the setup.\nThank you for reading the article. Cheers ðŸ˜„\n"},"name":"Battery Notifications in i3","published":"2018-06-12T09:45:46+05:30","summary":"I am using i3 window manager for the last seven months, and it has been a pleasant and productive experience so far. There were a few hiccups here and there, but that is expected with such minimalistic setups. One thing that I never noticed was the lack of notifications on critical battery levels. For the last few months, my laptop battery was discharging to 0% all the time. Probably this proved to be too fatal for my battery.","type":"entry","url":"https://yashagarwal.in/posts/2018/06/battery-notifications-in-i3/"}